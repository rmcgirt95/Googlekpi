<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Website Traffic KPI Dashboard (Mock API)</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --card2:#0c1730;
      --text:#e9f0ff;
      --muted:#a9b7d6;
      --border:rgba(255,255,255,.08);
      --accent:#4ea1ff;
      --good:#41d18b;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 16px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(78,161,255,.18), transparent 60%),
                  radial-gradient(1000px 700px at 80% 20%, rgba(65,209,139,.12), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 16px 50px;
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    h1{
      margin:0;
      font-size: 20px;
      letter-spacing: .2px;
    }
    .subtitle{
      margin-top:6px;
      color: var(--muted);
      font-size: 13px;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .control{
      display:flex;
      gap:8px;
      align-items:center;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,.18);
    }
    .control label{
      font-size:12px;
      color: var(--muted);
      white-space: nowrap;
    }
    select, input[type="date"]{
      background: transparent;
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      border-radius: 10px;
      padding: 6px 10px;
      outline: none;
      font-size: 13px;
    }
    select option{ color:#0b1220; }

    button{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(78,161,255,.18), rgba(78,161,255,.05));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 650;
      box-shadow: var(--shadow);
      transition: transform .08s ease, border-color .15s ease;
    }
    button:hover{ border-color: rgba(78,161,255,.45); }
    button:active{ transform: translateY(1px); }

    .grid{
      display:grid;
      gap: 12px;
    }
    .kpis{
      grid-template-columns: repeat(4, minmax(0, 1fr));
      margin-top: 10px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset: -40px -80px auto auto;
      width: 180px;
      height: 180px;
      background: radial-gradient(circle at 30% 30%, rgba(78,161,255,.25), transparent 60%);
      filter: blur(0px);
      pointer-events: none;
    }

    .kpi-label{
      color: var(--muted);
      font-size: 12px;
      letter-spacing: .3px;
    }
    .kpi-value{
      margin-top: 6px;
      font-size: 24px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .kpi-delta{
      margin-top: 6px;
      display:flex;
      gap:8px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
    }
    .pill{
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    .pill.good{ color: var(--good); border-color: rgba(65,209,139,.25); background: rgba(65,209,139,.08); }
    .pill.bad{ color: var(--bad); border-color: rgba(255,107,107,.25); background: rgba(255,107,107,.08); }

    .main{
      grid-template-columns: 2fr 1fr;
      margin-top: 12px;
      align-items: start;
    }

    .card-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .card-title h2{
      margin:0;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .chart-wrap{
      width:100%;
      height: 260px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(12,23,48,.6), rgba(12,23,48,.2));
      overflow:hidden;
      position: relative;
    }

    .chart-legend{
      margin-top: 10px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display:inline-block;
      margin-right: 6px;
      background: var(--accent);
    }

    table{
      width:100%;
      border-collapse: collapse;
      overflow: hidden;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(12,23,48,.35);
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      text-align:left;
      font-size: 13px;
    }
    th{
      color: var(--muted);
      font-size: 12px;
      letter-spacing: .2px;
      background: rgba(255,255,255,.03);
    }
    tr:last-child td{ border-bottom:none; }
    .mono{ font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }

    .statusbar{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top: 12px;
      color: var(--muted);
      font-size: 12px;
    }
    .spinner{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.15);
      border-top-color: rgba(78,161,255,.75);
      animation: spin .7s linear infinite;
      display:none;
    }
    @keyframes spin { to { transform: rotate(360deg);} }

    .error{
      color: var(--bad);
      font-weight: 650;
    }

    @media (max-width: 980px){
      .kpis{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .main{ grid-template-columns: 1fr; }
      .chart-wrap{ height: 240px; }
    }
    @media (max-width: 520px){
      .control{ width: 100%; justify-content: space-between; }
      select, input[type="date"]{ width: 55%; }
      button{ width: 100%; }
      .kpis{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Website Traffic KPI Dashboard</h1>
        <div class="subtitle">Mock API → mock data → custom KPIs (Users, Sessions, Pageviews, Conversion Rate)</div>
      </div>

      <div class="controls">
        <div class="control">
          <label for="range">Range</label>
          <select id="range">
            <option value="7">Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
          </select>
        </div>

        <div class="control">
          <label for="source">Source</label>
          <select id="source">
            <option value="all" selected>All</option>
            <option value="organic">Organic Search</option>
            <option value="direct">Direct</option>
            <option value="referral">Referral</option>
            <option value="social">Social</option>
            <option value="paid">Paid</option>
          </select>
        </div>

        <button id="refreshBtn">Refresh</button>
      </div>
    </header>

    <section class="grid kpis">
      <div class="card">
        <div class="kpi-label">Users</div>
        <div class="kpi-value mono" id="kpiUsers">—</div>
        <div class="kpi-delta"><span class="pill" id="deltaUsers">—</span><span>vs previous period</span></div>
      </div>

      <div class="card">
        <div class="kpi-label">Sessions</div>
        <div class="kpi-value mono" id="kpiSessions">—</div>
        <div class="kpi-delta"><span class="pill" id="deltaSessions">—</span><span>vs previous period</span></div>
      </div>

      <div class="card">
        <div class="kpi-label">Pageviews</div>
        <div class="kpi-value mono" id="kpiViews">—</div>
        <div class="kpi-delta"><span class="pill" id="deltaViews">—</span><span>vs previous period</span></div>
      </div>

      <div class="card">
        <div class="kpi-label">Conversion Rate</div>
        <div class="kpi-value mono" id="kpiCvr">—</div>
        <div class="kpi-delta"><span class="pill" id="deltaCvr">—</span><span>vs previous period</span></div>
      </div>
    </section>

    <section class="grid main">
      <div class="card">
        <div class="card-title">
          <h2>Sessions over time</h2>
          <div class="hint" id="chartHint">—</div>
        </div>
        <div class="chart-wrap" id="chartBox">
          <svg id="chartSvg" width="100%" height="100%" viewBox="0 0 900 300" preserveAspectRatio="none" aria-label="Line chart"></svg>
        </div>
        <div class="chart-legend">
          <span><span class="dot"></span>Sessions</span>
          <span class="hint">Tip: change Range/Source and hit Refresh</span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <h2>Top pages</h2>
          <div class="hint">by views</div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Page</th>
              <th class="mono">Views</th>
              <th class="mono">Avg Eng.</th>
            </tr>
          </thead>
          <tbody id="pagesTbody">
            <tr><td colspan="3" class="hint">—</td></tr>
          </tbody>
        </table>

        <div class="statusbar">
          <div class="spinner" id="spinner"></div>
          <div id="statusText">Ready.</div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ----------------------------
    // Mock API (simulates a backend)
    // ----------------------------
    function mockFetchTraffic({ days, source }) {
      // Simulate network latency
      const latencyMs = 550 + Math.floor(Math.random() * 650);

      // Deterministic-ish randomness per query (so toggling feels consistent)
      const seed = hashString(days + "|" + source);
      const rand = mulberry32(seed);

      // Helper: make a date array for the last N days
      const end = new Date();
      const dates = [];
      for (let i = days - 1; i >= 0; i--) {
        const d = new Date(end);
        d.setDate(end.getDate() - i);
        dates.push(d);
      }

      // Source multipliers (traffic volume + conversion tendency)
      const sourceProfile = {
        all:     { vol: 1.00, cvr: 1.00 },
        organic: { vol: 0.52, cvr: 1.10 },
        direct:  { vol: 0.26, cvr: 1.25 },
        referral:{ vol: 0.14, cvr: 0.95 },
        social:  { vol: 0.08, cvr: 0.80 },
        paid:    { vol: 0.10, cvr: 1.35 },
      }[source] || { vol: 1.00, cvr: 1.00 };

      // Generate timeseries
      const base = 420 * sourceProfile.vol; // baseline sessions/day
      const series = dates.map((d, idx) => {
        // Weekly seasonality + mild upward trend + noise
        const dow = d.getDay(); // 0..6
        const weekdayBoost = [0.92, 1.00, 1.06, 1.08, 1.05, 0.98, 0.90][dow];
        const trend = 1 + (idx / Math.max(1, days - 1)) * 0.12;
        const noise = 0.82 + rand() * 0.42;

        const sessions = Math.max(0, Math.round(base * weekdayBoost * trend * noise));
        const users = Math.max(0, Math.round(sessions * (0.62 + rand() * 0.18))); // users < sessions
        const views = Math.max(0, Math.round(sessions * (2.2 + rand() * 0.9)));   // pageviews
        const avgEngSec = Math.round(55 + rand() * 95);                           // 55s..150s

        // Conversions correlated with sessions + sourceProfile.cvr
        const cvr = (0.018 + rand() * 0.018) * sourceProfile.cvr;                 // ~1.8%..3.6% scaled
        const conversions = Math.round(sessions * cvr);

        return {
          date: d.toISOString().slice(0, 10),
          sessions,
          users,
          views,
          avgEngSec,
          conversions
        };
      });

      // Previous period: same length, slightly different noise
      const prevSeries = series.map((row) => {
        // create "previous" period by scaling down/up modestly
        const scale = 0.88 + rand() * 0.18; // ~0.88..1.06
        const sessions = Math.round(row.sessions * scale);
        const users = Math.round(row.users * scale);
        const views = Math.round(row.views * scale);
        const conversions = Math.round(row.conversions * scale);
        return { ...row, sessions, users, views, conversions };
      });

      // Top pages (mock)
      const basePages = [
        { page: "/", weight: 1.0 },
        { page: "/company-overview", weight: 0.42 },
        { page: "/mod-list/", weight: 0.20 },
        { page: "/resources/#oligoModificationSerie", weight: 0.33 },
        { page: "/news-and-events/", weight: 0.26 },
        { page: "/technology/", weight: 0.18 },
      ];
      const pages = basePages.map(p => {
        const views = Math.round(total(series, "views") * (p.weight * (0.06 + rand()*0.06)));
        const avgEngSec = Math.round(45 + rand()*135);
        return { page: p.page, views, avgEngSec };
      }).sort((a,b) => b.views - a.views).slice(0, 5);

      return new Promise((resolve) => {
        setTimeout(() => {
          resolve({
            query: { days, source },
            series,
            prevSeries,
            pages
          });
        }, latencyMs);
      });
    }

    // ----------------------------
    // Utilities
    // ----------------------------
    function total(rows, key){
      return rows.reduce((sum, r) => sum + (Number(r[key]) || 0), 0);
    }

    function pctChange(current, previous){
      if (previous === 0) return current === 0 ? 0 : 100;
      return ((current - previous) / previous) * 100;
    }

    function fmtInt(n){
      return Number(n || 0).toLocaleString();
    }

    function fmtPct(p){
      const sign = p >= 0 ? "+" : "";
      return sign + p.toFixed(1) + "%";
    }

    function fmtTime(sec){
      sec = Math.max(0, Math.round(sec || 0));
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      if (m <= 0) return s + "s";
      return m + "m " + String(s).padStart(2, "0") + "s";
    }

    function setDelta(el, pct){
      el.textContent = fmtPct(pct);
      el.classList.remove("good","bad");
      if (pct >= 0.01) el.classList.add("good");
      else if (pct <= -0.01) el.classList.add("bad");
    }

    // Simple stable hash for seeds
    function hashString(str){
      let h = 2166136261;
      for (let i = 0; i < str.length; i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }

    // PRNG
    function mulberry32(a) {
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      }
    }

    // ----------------------------
    // Chart rendering (SVG)
    // ----------------------------
    function renderLineChart(svgEl, series){
      const W = 900, H = 300;
      const padL = 44, padR = 14, padT = 12, padB = 30;

      const values = series.map(r => r.sessions);
      const minV = Math.min(...values);
      const maxV = Math.max(...values);
      const range = Math.max(1, maxV - minV);

      const x = (i) => {
        const n = Math.max(1, series.length - 1);
        return padL + (i / n) * (W - padL - padR);
      };
      const y = (v) => {
        const t = (v - minV) / range;
        return (H - padB) - t * (H - padT - padB);
      };

      // Build path
      const d = series.map((r, i) => `${i===0 ? "M" : "L"} ${x(i).toFixed(2)} ${y(r.sessions).toFixed(2)}`).join(" ");

      // Clear SVG
      svgEl.innerHTML = "";

      // Grid lines (horizontal)
      const grid = document.createElementNS("http://www.w3.org/2000/svg", "g");
      for (let i=0;i<4;i++){
        const gy = padT + (i/3)*(H-padT-padB);
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", padL);
        line.setAttribute("x2", W - padR);
        line.setAttribute("y1", gy);
        line.setAttribute("y2", gy);
        line.setAttribute("stroke", "rgba(255,255,255,0.07)");
        line.setAttribute("stroke-width", "1");
        grid.appendChild(line);
      }
      svgEl.appendChild(grid);

      // Y-axis labels (min/max + 2 mid)
      const labels = [
        { v: maxV, y: y(maxV) },
        { v: minV + range*0.66, y: y(minV + range*0.66) },
        { v: minV + range*0.33, y: y(minV + range*0.33) },
        { v: minV, y: y(minV) },
      ];
      labels.forEach(l => {
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", 10);
        text.setAttribute("y", l.y + 4);
        text.setAttribute("fill", "rgba(233,240,255,0.65)");
        text.setAttribute("font-size", "12");
        text.textContent = fmtInt(Math.round(l.v));
        svgEl.appendChild(text);
      });

      // Area fill
      const area = document.createElementNS("http://www.w3.org/2000/svg", "path");
      const areaD = `${d} L ${x(series.length-1).toFixed(2)} ${(H-padB).toFixed(2)} L ${x(0).toFixed(2)} ${(H-padB).toFixed(2)} Z`;
      area.setAttribute("d", areaD);
      area.setAttribute("fill", "rgba(78,161,255,0.12)");
      svgEl.appendChild(area);

      // Line path
      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("d", d);
      path.setAttribute("fill", "none");
      path.setAttribute("stroke", "rgba(78,161,255,0.95)");
      path.setAttribute("stroke-width", "3");
      path.setAttribute("stroke-linecap", "round");
      path.setAttribute("stroke-linejoin", "round");
      svgEl.appendChild(path);

      // Last point marker
      const last = series[series.length-1];
      const cx = x(series.length-1), cy = y(last.sessions);
      const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      dot.setAttribute("cx", cx);
      dot.setAttribute("cy", cy);
      dot.setAttribute("r", "5");
      dot.setAttribute("fill", "rgba(78,161,255,1)");
      dot.setAttribute("stroke", "rgba(255,255,255,0.65)");
      dot.setAttribute("stroke-width", "2");
      svgEl.appendChild(dot);

      // X-axis labels (first, mid, last)
      const idxs = [0, Math.floor((series.length-1)/2), series.length-1];
      idxs.forEach(i => {
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", x(i));
        text.setAttribute("y", H - 10);
        text.setAttribute("fill", "rgba(233,240,255,0.65)");
        text.setAttribute("font-size", "12");
        text.setAttribute("text-anchor", i === 0 ? "start" : (i === series.length-1 ? "end" : "middle"));
        text.textContent = series[i].date.slice(5);
        svgEl.appendChild(text);
      });
    }

    // ----------------------------
    // UI wiring
    // ----------------------------
    const els = {
      range: document.getElementById("range"),
      source: document.getElementById("source"),
      refreshBtn: document.getElementById("refreshBtn"),
      spinner: document.getElementById("spinner"),
      statusText: document.getElementById("statusText"),
      chartSvg: document.getElementById("chartSvg"),
      chartHint: document.getElementById("chartHint"),

      kpiUsers: document.getElementById("kpiUsers"),
      kpiSessions: document.getElementById("kpiSessions"),
      kpiViews: document.getElementById("kpiViews"),
      kpiCvr: document.getElementById("kpiCvr"),

      deltaUsers: document.getElementById("deltaUsers"),
      deltaSessions: document.getElementById("deltaSessions"),
      deltaViews: document.getElementById("deltaViews"),
      deltaCvr: document.getElementById("deltaCvr"),

      pagesTbody: document.getElementById("pagesTbody"),
    };

    function setLoading(isLoading){
      els.spinner.style.display = isLoading ? "inline-block" : "none";
      els.refreshBtn.disabled = isLoading;
      els.refreshBtn.style.opacity = isLoading ? "0.7" : "1";
    }

    function setStatus(msg, isError=false){
      els.statusText.textContent = msg;
      els.statusText.classList.toggle("error", !!isError);
    }

    function renderPages(pages){
      els.pagesTbody.innerHTML = "";
      pages.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(p.page)}</td>
          <td class="mono">${fmtInt(p.views)}</td>
          <td class="mono">${fmtTime(p.avgEngSec)}</td>
        `;
        els.pagesTbody.appendChild(tr);
      });
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function computeAndRender(data){
      const cur = data.series;
      const prev = data.prevSeries;

      const curUsers = total(cur, "users");
      const curSessions = total(cur, "sessions");
      const curViews = total(cur, "views");
      const curConv = total(cur, "conversions");

      const prevUsers = total(prev, "users");
      const prevSessions = total(prev, "sessions");
      const prevViews = total(prev, "views");
      const prevConv = total(prev, "conversions");

      const curCvr = curSessions === 0 ? 0 : (curConv / curSessions) * 100;
      const prevCvr = prevSessions === 0 ? 0 : (prevConv / prevSessions) * 100;

      els.kpiUsers.textContent = fmtInt(curUsers);
      els.kpiSessions.textContent = fmtInt(curSessions);
      els.kpiViews.textContent = fmtInt(curViews);
      els.kpiCvr.textContent = curCvr.toFixed(2) + "%";

      setDelta(els.deltaUsers, pctChange(curUsers, prevUsers));
      setDelta(els.deltaSessions, pctChange(curSessions, prevSessions));
      setDelta(els.deltaViews, pctChange(curViews, prevViews));
      setDelta(els.deltaCvr, pctChange(curCvr, prevCvr));

      renderLineChart(els.chartSvg, cur);
      renderPages(data.pages);

      const start = cur[0]?.date;
      const end = cur[cur.length-1]?.date;
      const sourceLabel = els.source.options[els.source.selectedIndex].text;
      els.chartHint.textContent = `${sourceLabel} • ${start} → ${end}`;
    }

    async function refresh(){
      const days = Number(els.range.value);
      const source = els.source.value;

      setLoading(true);
      setStatus("Loading mock analytics…");

      try{
        const data = await mockFetchTraffic({ days, source });
        computeAndRender(data);
        setStatus(`Updated. (Mock API) Range: ${days} days • Source: ${source}`);
      } catch (err){
        console.error(err);
        setStatus("Failed to load mock data.", true);
      } finally{
        setLoading(false);
      }
    }

    els.refreshBtn.addEventListener("click", refresh);

    // Auto-refresh on selection change (optional)
    els.range.addEventListener("change", refresh);
    els.source.addEventListener("change", refresh);

    // Initial load
    refresh();
  </script>
</body>
</html>
